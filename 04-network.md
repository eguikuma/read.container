<div align="right">
<img src="https://img.shields.io/badge/AI-ASSISTED_STUDY-3b82f6?style=for-the-badge&labelColor=1e293b&logo=bookstack&logoColor=white" alt="AI Assisted Study" />
</div>

# 04-network：ネットワーク

## はじめに

[03-image](./03-image.md) では、コンテナイメージの仕組みを学びました

イメージからコンテナが作られ、overlay filesystem によって読み取り専用のイメージレイヤと書き込み可能なコンテナレイヤが統合されます

しかし、コンテナはデフォルトで独自の Network namespace を持つため、ホストや他のコンテナと<strong>ネットワーク的に隔離</strong>されています

では、コンテナはどうやって外部と通信するのでしょうか？

Web サーバーのコンテナにブラウザからアクセスできるのはなぜでしょうか？

複数のコンテナ同士はどうやって通信しているのでしょうか？

このトピックでは、コンテナネットワークの仕組みを学びます

---

## 日常の例え

コンテナネットワークを「オフィスビルの電話システム」に例えてみましょう

<strong>Network namespace</strong>

各オフィス（コンテナ）には独自の内線電話網があります

オフィスの中では自由に内線通話できますが、そのままでは他のオフィスや外部と通話できません

<strong>veth ペア</strong>

各オフィスからビルの共用スペースまで引かれた<strong>電話ケーブル</strong>です

ケーブルの一端はオフィス内に、もう一端はビルの電話交換機につながっています

<strong>bridge</strong>

ビル内の<strong>電話交換機</strong>です

複数のオフィスからのケーブルが接続され、オフィス間の通話を取り次ぎます

<strong>ポートマッピング</strong>

ビルの<strong>外線番号</strong>です

外部から特定の外線番号に電話すると、交換機が該当するオフィスの内線に転送します

---

## このページで学ぶこと

このページでは、以下の概念を学びます

<strong>コンテナネットワークの基盤</strong>

- <strong>Network namespace</strong>
  - コンテナごとに独立したネットワークスタック
- <strong>veth ペア</strong>
  - コンテナとホストをつなぐ仮想ネットワークケーブル

<strong>通信の仕組み</strong>

- <strong>bridge ネットワーク</strong>
  - 複数のコンテナを接続する仮想スイッチ
- <strong>ポートマッピング</strong>
  - ホストのポートをコンテナのポートに転送する仕組み
- <strong>コンテナ間通信</strong>
  - 同一ネットワーク上のコンテナ同士の通信と DNS

<strong>ネットワークドライバ</strong>

- <strong>ネットワークドライバの種類</strong>
  - bridge / host / none / overlay の概要

---

## 目次

1. [コンテナネットワークの全体像](#コンテナネットワークの全体像)
2. [Network namespace](#network-namespace)
3. [veth ペア](#veth-ペア)
4. [bridge ネットワーク](#bridge-ネットワーク)
5. [コンテナの通信フロー](#コンテナの通信フロー)
6. [ポートマッピング](#ポートマッピング)
7. [コンテナ間通信](#コンテナ間通信)
8. [ネットワークドライバの種類](#ネットワークドライバの種類)
9. [次のトピックへ](#次のトピックへ)
10. [用語集](#用語集)
11. [参考資料](#参考資料)

---

## コンテナネットワークの全体像

コンテナネットワークは、以下の要素で構成されています

```
外部ネットワーク
      │
      │
  ┌───┴───┐
  │ ホスト │  eth0（物理インターフェース）
  │       │
  │  docker0（bridge）
  │  ┌──┴──┐
  │  │     │
  │ veth  veth
  │  │     │
  ├──┤     ├──┐
│コンテナA│ │コンテナB│
│ eth0   │ │ eth0   │
│10.0.0.2│ │10.0.0.3│
└────────┘ └────────┘
```

各コンテナは独自の Network namespace を持ち、bridge を通じてホストや他のコンテナと接続されます

---

## Network namespace

[01-container](./01-container.md) で学んだように、Network namespace はネットワークスタック全体を隔離するカーネル機能です

各コンテナは独自の Network namespace を持ち、以下のリソースがコンテナごとに独立します

| リソース                     | 説明                           |
| ---------------------------- | ------------------------------ |
| ネットワークインターフェース | eth0、lo など                  |
| IP アドレス                  | コンテナ固有の IP アドレス     |
| ポート                       | コンテナ内でリッスンするポート |
| ルーティングテーブル         | パケットの送信先の決定ルール   |
| iptables / nftables ルール   | パケットフィルタリングのルール |

### 新しい Network namespace の初期状態

コンテナ用の新しい Network namespace が作成された直後は、<strong>lo（ループバック）インターフェースだけ</strong>が存在します

lo はまだ起動していない状態（DOWN）であり、外部との通信手段もありません

コンテナが外部と通信するためには、ネットワークインターフェースを追加し、bridge と接続する必要があります

これを行うのがコンテナランタイムの役割です

---

## veth ペア

<strong>veth</strong>（Virtual Ethernet）ペアは、2つの仮想ネットワークインターフェースがペアになったものです

一方のインターフェースに送信したパケットは、もう一方のインターフェースで受信されます

### veth ペアの仕組み

```
コンテナの Network namespace      ホストの Network namespace
┌─────────────────────┐         ┌─────────────────────┐
│                     │         │                     │
│   eth0 ─────────────────────── vethXXXX             │
│  （コンテナ側）      │         │ （ホスト側）         │
│                     │         │                     │
└─────────────────────┘         └─────────────────────┘
```

veth ペアの一端はコンテナの Network namespace 内に配置され、コンテナから見ると eth0 として見えます

もう一端はホストの Network namespace に残り、bridge に接続されます

### veth ペアの特徴

- 仮想的な「ケーブル」であり、物理的なネットワーク機器は不要
- 一方に送ったパケットは必ずもう一方で受信される
- 異なる Network namespace をまたいでパケットを転送できる
- コンテナが削除されると、対応する veth ペアも削除される

---

## bridge ネットワーク

<strong>bridge</strong>（ブリッジ）は、複数のネットワークインターフェースを接続する仮想的なネットワークスイッチです

Docker はデフォルトで <strong>docker0</strong> という bridge を作成します

### bridge の役割

```
docker0（bridge）─── 172.17.0.1
    │
    ├── vethA ─── コンテナ A（172.17.0.2）
    ├── vethB ─── コンテナ B（172.17.0.3）
    └── vethC ─── コンテナ C（172.17.0.4）
```

bridge は以下の役割を持ちます

- 接続されたコンテナ間のパケット転送（MAC アドレスに基づいてパケットを転送するレイヤ 2 スイッチとして動作）
- コンテナへの IP アドレス割り当てのゲートウェイ
- コンテナから外部への通信の中継点

### bridge の IP アドレス

bridge 自体にも IP アドレスが割り当てられます（例：172.17.0.1）

この IP アドレスは、bridge に接続されたコンテナにとっての<strong>デフォルトゲートウェイ</strong>です

コンテナが外部に通信する際、パケットはまず bridge に送られます

### ユーザー定義 bridge

Docker はデフォルトの docker0 bridge に加えて、ユーザーが独自の bridge を作成できます

```
docker network create my-network
```

ユーザー定義 bridge はデフォルト bridge と比べて以下の利点があります

| 機能                     | デフォルト bridge（docker0）       | ユーザー定義 bridge          |
| ------------------------ | ---------------------------------- | ---------------------------- |
| DNS によるコンテナ名解決 | 利用不可                           | 利用可能                     |
| コンテナの接続・切断     | コンテナの再起動が必要             | 実行中のコンテナに対して可能 |
| ネットワークの分離       | すべてのコンテナが同じネットワーク | ネットワークごとに分離       |

---

## コンテナの通信フロー

### コンテナから外部への通信

コンテナから外部の Web サイトにアクセスする場合の通信フローです

```
コンテナ（172.17.0.2）
    │
    │ パケット送信
    ↓
  veth ペア
    │
    ↓
  docker0 bridge（172.17.0.1）
    │
    │ NAT（送信元アドレスをホストの IP に変換）
    ↓
  ホストの eth0
    │
    ↓
  外部ネットワーク
```

コンテナのプライベート IP アドレス（172.17.0.2）は外部から到達できないため、ホストのカーネルが <strong>NAT</strong>（Network Address Translation）を行います

NAT により、コンテナからのパケットの送信元アドレスがホストの IP アドレスに変換され、外部と通信できるようになります

### 外部からコンテナへの通信

外部からコンテナに直接アクセスするには、<strong>ポートマッピング</strong>が必要です

これは次のセクションで説明します

---

## ポートマッピング

コンテナは独自の Network namespace を持つため、コンテナ内のポートにはそのままではホスト外部からアクセスできません

<strong>ポートマッピング</strong>は、ホストの特定のポートをコンテナのポートに転送する仕組みです

### ポートマッピングの設定

```
docker run -p 8080:80 nginx
```

この例では、ホストのポート 8080 をコンテナのポート 80 に転送します

外部からホストの 8080 番ポートにアクセスすると、そのリクエストはコンテナの 80 番ポートに転送されます

### 動作の仕組み

```
外部クライアント
    │
    │ ホスト:8080 にアクセス
    ↓
  ホストの iptables / nftables ルール
    │
    │ 宛先を 172.17.0.2:80 に書き換え（DNAT）
    ↓
  docker0 bridge
    │
    ↓
  コンテナ（172.17.0.2:80）
```

Docker はコンテナ起動時に、ホストの iptables（または nftables）にルールを追加します

このルールが、ホストのポート 8080 に届いたパケットの宛先をコンテナの IP アドレスとポートに書き換えます（<strong>DNAT</strong>: Destination NAT）

### よく使われるポートマッピングの形式

| 形式                   | 説明                                             |
| ---------------------- | ------------------------------------------------ |
| `-p 8080:80`           | ホストの 8080 をコンテナの 80 に転送             |
| `-p 80`                | ホストのランダムなポートをコンテナの 80 に転送   |
| `-p 127.0.0.1:8080:80` | ローカルホストの 8080 のみをコンテナの 80 に転送 |

---

## コンテナ間通信

同じ bridge ネットワークに接続されたコンテナは、互いに通信できます

### IP アドレスによる通信

同一 bridge 上のコンテナは、IP アドレスを指定して直接通信できます

```
コンテナ A（172.17.0.2）──→ docker0 ──→ コンテナ B（172.17.0.3）
```

bridge がレイヤ 2 スイッチとして動作し、パケットを転送します

### DNS によるコンテナ名解決

ユーザー定義 bridge では、コンテナ名で通信できます

```
docker network create my-network
docker run --name web --network my-network nginx
docker run --name app --network my-network myapp
```

この場合、app コンテナから `http://web:80` でアクセスできます

Docker がコンテナ用の<strong>内部 DNS サーバー</strong>（127.0.0.11）を提供し、コンテナ名を IP アドレスに解決します

### 異なるネットワーク間の分離

異なる bridge ネットワークに接続されたコンテナは、デフォルトでは互いに通信できません

```
my-network-1             my-network-2
┌──────────────┐        ┌──────────────┐
│ コンテナ A   │        │ コンテナ C   │
│ コンテナ B   │   ×    │ コンテナ D   │
└──────────────┘        └──────────────┘
       通信不可
```

この分離により、関連するコンテナだけを同じネットワークに配置し、不要な通信を防ぐことができます

---

## ネットワークドライバの種類

Docker はさまざまなネットワークドライバを提供しています

| ドライバ | 説明                                                 | 用途                            |
| -------- | ---------------------------------------------------- | ------------------------------- |
| bridge   | 仮想ブリッジで複数のコンテナを接続する（デフォルト） | 同一ホスト上のコンテナ間通信    |
| host     | コンテナがホストのネットワークスタックを直接使用する | ネットワーク性能が必要な場合    |
| none     | ネットワークを無効にする                             | ネットワーク不要なコンテナ      |
| overlay  | 複数のホストにまたがるネットワークを作成する         | Docker Swarm や Kubernetes 環境 |

### host ドライバ

```
docker run --network host nginx
```

host ドライバを使うと、コンテナは Network namespace を作成しません

コンテナのプロセスはホストのネットワークスタックを直接使用します

ポートマッピングは不要ですが、コンテナのネットワーク隔離がなくなります

### none ドライバ

```
docker run --network none myapp
```

none ドライバを使うと、コンテナにはループバックインターフェース（lo）だけが存在します

外部との通信が完全に遮断されるため、ネットワークアクセスが不要なバッチ処理などに使います

---

## 次のトピックへ

このトピックでは、以下のことを学びました

- Network namespace がコンテナごとに独立したネットワークスタックを提供する
- veth ペアがコンテナと bridge をつなぐ仮想ケーブルの役割を果たす
- bridge がコンテナ同士やコンテナと外部の通信を仲介する
- ポートマッピングが iptables / nftables を使ってホストのポートをコンテナに転送する
- ユーザー定義 bridge では DNS によるコンテナ名解決が使える

これで、コンテナがどうやって通信するかが分かりました

しかし、コンテナにはもう1つ大きな課題があります

コンテナのファイルシステムは一時的（ephemeral）であり、コンテナを削除するとデータも消えてしまいます

次のトピック [05-storage](./05-storage.md) では、<strong>コンテナのストレージ</strong>を学びます

ボリューム、バインドマウント、ストレージドライバの仕組みを理解することで、コンテナでデータを永続化する方法が分かります

---

## 用語集

| 用語                               | 説明                                                                                         |
| ---------------------------------- | -------------------------------------------------------------------------------------------- |
| Network namespace                  | ネットワークスタック全体（インターフェース、IP、ポート、ルーティング）を隔離するカーネル機能 |
| veth ペア                          | ペアになった仮想ネットワークインターフェース。一方に送ったパケットがもう一方で受信される     |
| bridge                             | 複数のネットワークインターフェースを接続する仮想スイッチ                                     |
| docker0                            | Docker がデフォルトで作成する bridge                                                         |
| デフォルトゲートウェイ             | パケットの送信先が不明な場合にパケットを送るルーター                                         |
| ユーザー定義 bridge                | ユーザーが `docker network create` で作成した bridge                                         |
| ポートマッピング                   | ホストのポートをコンテナのポートに転送する仕組み                                             |
| NAT（Network Address Translation） | パケットの送信元または宛先 IP アドレスを変換する技術                                         |
| DNAT（Destination NAT）            | パケットの宛先アドレスを変換する NAT の一種。ポートマッピングの実現に使われる                |
| iptables                           | Linux カーネルのパケットフィルタリングフレームワーク                                         |
| nftables                           | iptables の後継となるパケットフィルタリングフレームワーク                                    |
| 内部 DNS サーバー                  | Docker がユーザー定義 bridge で提供する DNS サーバー（127.0.0.11）                           |
| host ドライバ                      | コンテナがホストのネットワークスタックを直接使用するネットワークドライバ                     |
| none ドライバ                      | コンテナのネットワークを無効にするネットワークドライバ                                       |
| overlay ドライバ                   | 複数のホストにまたがるネットワークを作成するネットワークドライバ                             |
| ループバックインターフェース（lo） | 自分自身への通信に使う仮想ネットワークインターフェース（127.0.0.1）                          |

---

## 参考資料

このページの内容は、以下のソースに基づいています

<strong>namespace</strong>

- [namespaces(7) - Linux manual page](https://man7.org/linux/man-pages/man7/namespaces.7.html)
  - Network namespace を含む Linux namespace の概要

<strong>veth</strong>

- [veth(4) - Linux manual page](https://man7.org/linux/man-pages/man4/veth.4.html)
  - 仮想イーサネットデバイスペアの仕組み

<strong>ネットワーク管理</strong>

- [ip-link(8) - Linux manual page](https://man7.org/linux/man-pages/man8/ip-link.8.html)
  - ネットワークインターフェースの管理コマンド
- [bridge(8) - Linux manual page](https://man7.org/linux/man-pages/man8/bridge.8.html)
  - bridge の管理コマンド

<strong>パケットフィルタリング</strong>

- [iptables(8) - Linux manual page](https://man7.org/linux/man-pages/man8/iptables.8.html)
  - iptables によるパケットフィルタリングとNAT

<strong>Docker ネットワーク</strong>

- [Docker networking overview](https://docs.docker.com/engine/network/)
  - Docker のネットワークドライバとネットワーク設定
